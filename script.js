// í•™ìŠµ ë°ì´í„° êµ¬ì¡°
const studyData = {
    "ç”Ÿæ´»": {
        "ç¬¬ä¸€è¯¾ ç”¨é¤": {
            mdFile: "data/01-01.md",
            audioFile: "audio/01-01.mp3"
        },
        "ç¬¬äºŒè¯¾ ç¾é£Ÿ": {
            mdFile: "data/01-02.md",
            audioFile: "audio/01-02.mp3"
        },
        "ç¬¬ä¸‰è¯¾ å‡ºè¡Œ": {
            mdFile: "data/01-03.md",
            audioFile: "audio/01-03.mp3"
        },
        "ç¬¬å››è¯¾ æ¸¸ç©": {
            mdFile: "data/01-04.md",
            audioFile: "audio/01-04.mp3"
        },
        "ç¬¬äº”è¯¾ èŠå¼€è½¦": {
            mdFile: "data/01-05.md",
            audioFile: "audio/01-05.mp3"
        },
        "ç¬¬å…­è¯¾ çˆ±å¥½": {
            mdFile: "data/01-06.md",
            audioFile: "audio/01-06.mp3"
        },
        "ç¬¬ä¸ƒè¯¾ èŠè´­ç‰©": {
            mdFile: "data/01-07.md",
            audioFile: "audio/01-07.mp3"
        },
        "ç¬¬å…«è¯¾ èŠæ•™è‚²": {
            mdFile: "data/01-08.md",
            audioFile: "audio/01-08.mp3"
        },
    },
    "ä¼šè®®": {
        "ç¬¬ä¸€è¯¾ ä¸»æŒä¼šè®®": {
            mdFile: "data/02-01.md",
            audioFile: "audio/02-01.mp3"
        },
        "ç¬¬äºŒè¯¾ è¡¨è¾¾æ„è§": {
            mdFile: "data/02-02.md",
            audioFile: "audio/02-02.mp3"
        },
        "ç¬¬ä¸‰è¯¾ æ„å¤–å¤„ç†": {
            mdFile: "data/02-03.md",
            audioFile: "audio/02-03.mp3"
        },
        "ç¬¬å››è¯¾ ä¼šè®®æ€»ç»“": {
            mdFile: "data/02-04.md",
            audioFile: "audio/02-04.mp3"
        },
        "ç¬¬äº”è¯¾ å®‰æ’å·¥ä½œ": {
            mdFile: "data/02-05.md",
            audioFile: "audio/02-05.mp3"
        },
        "ç¬¬å…­è¯¾ è§£å†³é—®é¢˜": {
            mdFile: "data/02-06.md",
            audioFile: "audio/02-06.mp3"
        },
        "ç¬¬ä¸ƒè¯¾ ä¿¡æ¯å…±äº«": {
            mdFile: "data/02-07.md",
            audioFile: "audio/02-07.mp3"
        },
        "ç¬¬å…«è¯¾ å·¥ä½œç£ä¿ƒ": {
            mdFile: "data/02-08.md",
            audioFile: "audio/02-08.mp3"
        },
    },
    "ç®¡ç†": {
        "ç¬¬ä¸€è¯¾ æ‹›è˜": {
            mdFile: "data/03-01.md",
            audioFile: "audio/03-01.mp3"
        },
        "ç¬¬äºŒè¯¾ å…¥èŒ": {
            mdFile: "data/03-02.md",
            audioFile: "audio/03-02.mp3"
        },
        "ç¬¬ä¸‰è¯¾ ç¦»èŒ": {
            mdFile: "data/03-03.md",
            audioFile: "audio/03-03.mp3"
        },
        "ç¬¬å››è¯¾ ä¸šåŠ¡è¿›å±•": {
            mdFile: "data/03-04.md",
            audioFile: "audio/03-04.mp3"
        },
        "ç¬¬äº”è¯¾ è€ƒæ ¸": {
            mdFile: "data/03-05.md",
            audioFile: "audio/03-05.mp3"
        },
        "ç¬¬å…­è¯¾ æŒ‡å¯¼": {
            mdFile: "data/03-06.md",
            audioFile: "audio/03-06.mp3"
        },
        "ç¬¬ä¸ƒè¯¾ æ¿€åŠ±": {
            mdFile: "data/03-07.md",
            audioFile: "audio/03-07.mp3"
        },
        "ç¬¬å…«è¯¾ æƒ…ç»ªç®¡ç†": {
            mdFile: "data/03-08.md",
            audioFile: "audio/03-08.mp3"
        },
    },
    "äº¤é™…": {
        "ç¬¬ä¸€è¯¾ ä»‹ç»": {
            mdFile: "data/04-01.md",
            audioFile: "audio/04-01.mp3"
        },
        "ç¬¬äºŒè¯¾ å®´è¯·": {
            mdFile: "data/04-02.md",
            audioFile: "audio/04-02.mp3"
        },
        "ç¬¬ä¸‰è¯¾ é…’æ–‡åŒ–": {
            mdFile: "data/04-03.md",
            audioFile: "audio/04-03.mp3"
        },
        "ç¬¬å››è¯¾ èŠ‚æ—¥æ–‡åŒ–": {
            mdFile: "data/04-04.md",
            audioFile: "audio/04-04.mp3"
        },
        "ç¬¬äº”è¯¾ å¾®ä¿¡": {
            mdFile: "data/04-05.md",
            audioFile: "audio/04-05.mp3"
        },
        "ç¬¬å…­è¯¾ ç”µè¯ç”µé‚®": {
            mdFile: "data/04-06.md",
            audioFile: "audio/04-06.mp3"
        },
        "ç¬¬ä¸ƒè¯¾ å‘è¨€": {
            mdFile: "data/04-07.md",
            audioFile: "audio/04-07.mp3"
        },
        "ç¬¬å…«è¯¾ æ¼”ç¤º": {
            mdFile: "data/04-08.md",
            audioFile: "audio/04-08.mp3"
        },
    },
};

const vocabFiles = [
    "vocab/v02-12.txt",
    "vocab/v02-13.txt",
    "vocab/v02-19.txt",
    "vocab/v02-20.txt",
    "vocab/v02-23.txt",
    "vocab/v02-24.txt",
    "vocab/v02-25.txt",
    "vocab/v02-26.txt",
    "vocab/v02-27.txt",
];

let allVocabData = []; // ì—¬ëŸ¬ íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ëª¨ë“  ë‹¨ì–´ë¥¼ ë‹´ì„ ë°°ì—´

// ì§€ì›í•  ì†ë„ ëª©ë¡
const playbackSpeeds = [0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5];
let currentSpeedIndex = 4; // ê¸°ë³¸ê°’ 1.0

document.addEventListener('DOMContentLoaded', () => {
    const menuContainer = document.getElementById('menu-container');

    for (const subject in studyData) {
        const subjectDiv = document.createElement('div');
        subjectDiv.className = 'subject-group';

        const subjectTitle = document.createElement('div');
        subjectTitle.className = 'subject-title';
        subjectTitle.textContent = subject;

        const chapterList = document.createElement('ul');
        chapterList.className = 'chapter-list';

        for (const chapter in studyData[subject]) {
            const chapterItem = document.createElement('li');
            chapterItem.className = 'chapter-item';
            chapterItem.textContent = chapter;

            chapterItem.addEventListener('click', () => {
                const displayTitle = `ã€${subject}ã€‘${chapter}`;
                loadContent(displayTitle, studyData[subject][chapter]);
            });

            chapterList.appendChild(chapterItem);
        }

        subjectTitle.addEventListener('click', () => {
            // 1. í™”ë©´ì— ìˆëŠ” ëª¨ë“  ë‹¨ì› ë¦¬ìŠ¤íŠ¸(.chapter-list)ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const allChapterLists = document.querySelectorAll('.chapter-list');

            // 2. ëª¨ë“  ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©´ì„œ, í˜„ì¬ í´ë¦­í•œ ê³¼ëª©ì˜ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ê²ƒì€ ëª¨ë‘ ë‹«ìŠµë‹ˆë‹¤.
            allChapterLists.forEach(list => {
                if (list !== chapterList) {
                    list.classList.remove('active');
                }
            });

            // 3. ë§ˆì§€ë§‰ìœ¼ë¡œ í˜„ì¬ í´ë¦­í•œ ê³¼ëª©ì˜ ë¦¬ìŠ¤íŠ¸ë§Œ ì—´ê¸°/ë‹«ê¸°ë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
            chapterList.classList.toggle('active');
        });

        subjectDiv.appendChild(subjectTitle);
        subjectDiv.appendChild(chapterList);
        menuContainer.appendChild(subjectDiv);
    }

    // ì†ë„ ì¡°ì ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
    const audioPlayer = document.getElementById('audio-player');
    const speedDisplay = document.getElementById('speed-display');
    const btnSpeedDown = document.getElementById('speed-down');
    const btnSpeedUp = document.getElementById('speed-up');

    function updateSpeed() {
        const speed = playbackSpeeds[currentSpeedIndex];
        audioPlayer.playbackRate = speed;
        speedDisplay.textContent = speed.toFixed(1) + 'x';
    }

    btnSpeedDown.addEventListener('click', () => {
        if (currentSpeedIndex > 0) {
            currentSpeedIndex--;
            updateSpeed();
        }
    });

    btnSpeedUp.addEventListener('click', () => {
        if (currentSpeedIndex < playbackSpeeds.length - 1) {
            currentSpeedIndex++;
            updateSpeed();
        }
    });

    // --- Top ë²„íŠ¼ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë° í´ë¦­ ë™ì‘ ì¶”ê°€ ---
    const topBtn = document.getElementById("top-btn");

    // í™”ë©´ì„ ìŠ¤í¬ë¡¤í•  ë•Œë§ˆë‹¤ ì‹¤í–‰
    window.addEventListener('scroll', () => {
        // í™”ë©´ì´ ìœ„ì—ì„œë¶€í„° 150px ì´ìƒ ë‚´ë ¤ì˜¤ë©´ ë²„íŠ¼ í‘œì‹œ, ì•„ë‹ˆë©´ ìˆ¨ê¹€
        if (document.body.scrollTop > 150 || document.documentElement.scrollTop > 150) {
            topBtn.style.display = "block";
        } else {
            topBtn.style.display = "none";
        }
    });

    // Top ë²„íŠ¼ í´ë¦­ ì‹œ ë§¨ ìœ„ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
    topBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // ìŠ¤í¬ë¡¤ì´ ëš ëŠê¸°ì§€ ì•Šê³  ë¶€ë“œëŸ½ê²Œ ì˜¬ë¼ê°€ë„ë¡ ì„¤ì •
        });
    });
});

async function loadContent(title, fileData) {
    document.getElementById('content-title').textContent = title;
    const scriptContainer = document.getElementById('script-container');
    const scriptElement = document.getElementById('script-text');

    // 1. ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë³€í™˜
    try {
        const response = await fetch(fileData.mdFile);
        if (!response.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const markdownText = await response.text();

        // marked.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (.innerHTML ì‚¬ìš©)
        scriptElement.innerHTML = marked.parse(markdownText);
        scriptContainer.classList.remove('hidden');

    } catch (error) {
        console.error('í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        scriptElement.innerHTML = `<p style="color:red;">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ê²½ë¡œ: ${fileData.mdFile}</p>`;
        scriptContainer.classList.remove('hidden');
    }

    // 2. ì˜¤ë””ì˜¤ ì—…ë°ì´íŠ¸
    const audioContainer = document.getElementById('audio-container');
    const audioPlayer = document.getElementById('audio-player');
    const audioSource = document.getElementById('audio-source');
    const speedDisplay = document.getElementById('speed-display');

    if (fileData.audioFile) {
        audioSource.src = fileData.audioFile;
        audioPlayer.load();

        // ë‹¨ì›ì„ ì´ë™í•  ë•Œë§ˆë‹¤ ì¬ìƒ ì†ë„ë¥¼ 1.0xë¡œ ì´ˆê¸°í™”
        currentSpeedIndex = 4;
        audioPlayer.playbackRate = 1.0;
        speedDisplay.textContent = '1.0x';

        audioContainer.classList.remove('hidden');
    } else {
        audioSource.removeAttribute('src');
        audioContainer.classList.add('hidden');
    }
}

// ==========================================
// ë‹¨ì–´ì¥ ëª¨ë“œ ë° í”Œë˜ì‹œì¹´ë“œ ê´€ë ¨ ë¡œì§
// ==========================================

const modeStudyBtn = document.getElementById('mode-study');
const modeVocabBtn = document.getElementById('mode-vocab');
const menuContainer = document.getElementById('menu-container');
const contentTitle = document.getElementById('content-title');
const audioContainer = document.getElementById('audio-container');
const scriptContainer = document.getElementById('script-container');
const vocabContainer = document.getElementById('vocab-container');

// 'ë³¸ë¬¸ í•™ìŠµ' ë²„íŠ¼ í´ë¦­ ì‹œ
modeStudyBtn.addEventListener('click', () => {
    modeStudyBtn.classList.add('active');
    modeVocabBtn.classList.remove('active');

    // ë³¸ë¬¸ ì˜ì—­ ê¸°ë³¸ UI ë³µêµ¬
    menuContainer.style.display = 'block';
    vocabContainer.classList.add('hidden');
    contentTitle.style.display = 'block';

    // ì´ì „ì— ì„ íƒí•´ë‘” ë³¸ë¬¸ í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ í‘œì‹œ
    if (document.getElementById('script-text').innerHTML.trim() !== "") {
        scriptContainer.classList.remove('hidden');

        const audioSource = document.getElementById('audio-source');
        if (audioSource.getAttribute('src')) {
            audioContainer.classList.remove('hidden');
        }
    }
});

// 'ë‹¨ì–´ì¥ ì—°ìŠµ' ë²„íŠ¼ í´ë¦­ ì‹œ
modeVocabBtn.addEventListener('click', () => {
    modeVocabBtn.classList.add('active');
    modeStudyBtn.classList.remove('active');

    // ë‹¨ì–´ì¥ ì˜ì—­ í‘œì‹œ
    menuContainer.style.display = 'none';
    contentTitle.style.display = 'none';
    audioContainer.classList.add('hidden');
    scriptContainer.classList.add('hidden');
    vocabContainer.classList.remove('hidden');

    // ë‹¨ì–´ ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    if (allVocabData.length === 0) {
        loadAllVocabAndDraw();
    }
});

// ì—¬ëŸ¬ ê°œì˜ í…ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì™€ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” í•¨ìˆ˜
async function loadAllVocabAndDraw() {
    allVocabData = []; // ì´ˆê¸°í™”

    for (const file of vocabFiles) {
        try {
            const response = await fetch(file);
            if (response.ok) {
                const text = await response.text();
                // ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
                const lines = text.split('\n');

                lines.forEach(line => {
                    // ë¹ˆ ì¤„ ë¬´ì‹œ
                    if (line.trim() !== '') {
                        // ' / ' ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì–´/ë³‘ìŒ/ëœ» ë¶„ë¦¬
                        const parts = line.split(' / ');
                        if (parts.length >= 3) {
                            // ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ë§¨ ì•ì˜ 'ìˆ«ì + ë§ˆì¹¨í‘œ + ê³µë°±'ì„ ì œê±°í•©ë‹ˆë‹¤. (ì˜ˆ: "1. å‚è§‚" -> "å‚è§‚")
                            let pureWord = parts[0].trim().replace(/^\d+\.\s*/, '');

                            allVocabData.push({
                                word: pureWord,
                                pinyin: parts[1].trim(),
                                meaning: parts[2].trim()
                            });
                        }
                    }
                });
            }
        } catch (error) {
            console.error(`ë‹¨ì–´ì¥ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ (${file}):`, error);
        }
    }

    // ë°ì´í„°ë¥¼ ëª¨ë‘ ë¶ˆëŸ¬ì˜¨ í›„ 10ê°œ ëœë¤ ë½‘ê¸° ì‹¤í–‰
    drawRandomVocab();
}

// ëœë¤ìœ¼ë¡œ 10ê°œë¥¼ ë½‘ì•„ í™”ë©´ì— ì¹´ë“œë¡œ ë§Œë“œëŠ” í•¨ìˆ˜
function drawRandomVocab() {
    const grid = document.getElementById('flashcard-grid');
    grid.innerHTML = ''; // ê¸°ì¡´ ì¹´ë“œ ì§€ìš°ê¸°

    if (allVocabData.length === 0) {
        grid.innerHTML = '<p>ë‹¨ì–´ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. txt íŒŒì¼ ê²½ë¡œì™€ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>';
        return;
    }

    // ì „ì²´ ë‹¨ì–´ ë°°ì—´ì„ ë¬´ì‘ìœ„ë¡œ ì„ê¸° (Fisher-Yates ì•Œê³ ë¦¬ì¦˜ ì‘ìš©)
    const shuffled = [...allVocabData].sort(() => 0.5 - Math.random());
    // ì„ì€ ë°°ì—´ì—ì„œ 10ê°œë§Œ ì¶”ì¶œ (ë‹¨ì–´ê°€ 10ê°œ ë¯¸ë§Œì´ë©´ ìˆëŠ” ë§Œí¼ë§Œ ì¶”ì¶œ)
    const selected = shuffled.slice(0, 10);

    selected.forEach(item => {
        const card = document.createElement('div');
        card.className = 'flashcard';

        // ğŸ‘‡ í•œê¸€ ëœ»ì˜ ê¸¸ì´ì— ë”°ë¼ ì ìš©í•  CSS í´ë˜ìŠ¤ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
        let meaningClass = 'fc-meaning';
        if (item.meaning.length > 25) {
            meaningClass += ' super-long'; // 25ì ì´ˆê³¼ ì‹œ ì•„ì£¼ ì‘ê²Œ
        } else if (item.meaning.length > 12) {
            meaningClass += ' long-text';  // 12ì ì´ˆê³¼ ì‹œ ì•½ê°„ ì‘ê²Œ
        }

        // ì¹´ë“œ ì•ˆì˜ HTML êµ¬ì„± (ê²°ì •ëœ í´ë˜ìŠ¤ë¥¼ ì ìš©)
        card.innerHTML = `
            <div class="fc-word">${item.word}</div>
            <div class="fc-pinyin">${item.pinyin}</div>
            <div class="${meaningClass}">${item.meaning}</div>
        `;

        // --- ğŸ‘‡ ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ë°©ì§€ ë° í„°ì¹˜ ë™ì‘ ê°œì„  ë¶€ë¶„ ---
        let startY = 0;
        let flipTimer;

        // 1. ë§ˆìš°ìŠ¤ë¥¼ ëˆ„ë¥´ê±°ë‚˜ í™”ë©´ì„ í„°ì¹˜í•  ë•Œ
        card.addEventListener('pointerdown', (e) => {
            startY = e.clientY; // í„°ì¹˜í•œ ì‹œì‘ì ì˜ Y(ì„¸ë¡œ) ì¢Œí‘œ ê¸°ë¡

            // ì¦‰ì‹œ ë’¤ì§‘ì§€ ì•Šê³  0.1ì´ˆ(100ms) ëŒ€ê¸°
            flipTimer = setTimeout(() => {
                card.classList.add('flipped');
            }, 100);
        });

        // 2. ì†ê°€ë½(ë˜ëŠ” ë§ˆìš°ìŠ¤)ì´ ì›€ì§ì¼ ë•Œ (ìŠ¤í¬ë¡¤ ê°ì§€)
        card.addEventListener('pointermove', (e) => {
            // ìœ„ì•„ë˜ë¡œ 10px ì´ìƒ ì›€ì§ì˜€ë‹¤ë©´ ìŠ¤í¬ë¡¤ë¡œ ê°„ì£¼
            if (Math.abs(e.clientY - startY) > 10) {
                clearTimeout(flipTimer); // ë’¤ì§‘ê¸° ì·¨ì†Œ
                card.classList.remove('flipped'); // ì´ë¯¸ ë’¤ì§‘í˜”ë‹¤ë©´ ë‹«ê¸°
            }
        });

        // 3. ì¹´ë“œë¥¼ ë‹¤ì‹œ ì›ë˜ëŒ€ë¡œ ë®ëŠ” ê³µí†µ í•¨ìˆ˜
        const hideCard = () => {
            clearTimeout(flipTimer);
            card.classList.remove('flipped');
        };

        // 4. ì†ì„ ë–¼ê±°ë‚˜, í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ê±°ë‚˜, ìŠ¤í¬ë¡¤ë¡œ ì¸í•´ í„°ì¹˜ê°€ ì·¨ì†Œë  ë•Œ ëª¨ë‘ ë®ê¸°
        card.addEventListener('pointerup', hideCard);
        card.addEventListener('pointerleave', hideCard);
        card.addEventListener('pointercancel', hideCard);

        // ëª¨ë°”ì¼ì—ì„œ ê¸¸ê²Œ ëˆŒë €ì„ ë•Œ ë³µì‚¬ ë©”ë‰´(ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´)ê°€ ëœ¨ëŠ” ê²ƒ ë°©ì§€
        card.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        grid.appendChild(card);
    });
}

// 'ìƒˆë¡œìš´ ë‹¨ì–´ ë½‘ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.getElementById('refresh-vocab-btn').addEventListener('click', drawRandomVocab);
